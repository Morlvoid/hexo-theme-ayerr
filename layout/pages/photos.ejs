<%- partial('head') %>
    <%- partial('lock') %>
        <%- partial('sidebar') %>

            <div id="main">
                <div class="content-wrap">
                    <div class="outer">
                        <div id="content" class="inner">
                            <article class="article">
                                <header class="article-header">
                                    <h1 class="article-title">画作</h1>
                                </header>

                                <div class="article-entry">
                                    <!-- 照片画廊 -->
                                    <div class="portfolio">
                                        <div class="spinner"><i></i></div>
                                        <div class="wrap" id="wrap" cloak>
                                            <% if (theme.photo && theme.photo.photos) { %>
                                                <% theme.photo.photos.forEach(function(photo, index) { %>
                                                    <div class="photo photo_front" onclick="turn(this)" id="photo_<%= index + 1 %>">
                                                        <div class="photo-wrap">
                                                            <div class="side side-front">
                                                                <p class="image">
                                                                    <img src="<%= photo.img %>" alt="<%= photo.caption %>">
                                                                </p>
                                                            </div>
                                                            <div class="side side-back">
                                                                <p class="caption">
                                                                    <%= photo.caption %>
                                                                </p>
                                                                <p class="desc">
                                                                    <%= photo.desc %>
                                                                </p>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <% }); %>
                                                        <% } %>
                                        </div>
                                        <!-- 导航点 -->
                                        <div class="nav-gallery">
                                            <% if (theme.photo && theme.photo.photos) { %>
                                                <% theme.photo.photos.forEach(function(photo, index) { %>
                                                    <span id="nav_<%= index + 1 %>" onclick="turn(document.getElementById('photo_<%= index + 1 %>'))" class="i"></span>
                                                    <% }); %>
                                                        <% } %>
                                        </div>
                                    </div>
                                </div>
                            </article>
                        </div>
                    </div>
                </div>
            </div>

            <%- partial('footer') %>
                <%- partial('after-footer') %>

                    <style>
                        /* 照片画廊样式 */
                        
                        .portfolio {
                            padding: 2rem 0;
                            position: relative;
                            min-height: 80vh;
                        }
                        
                        .spinner {
                            font-size: 80px;
                            width: 1em;
                            height: 1em;
                            position: absolute;
                            left: 50%;
                            top: 50%;
                            transform: translate(-50%, -50%);
                            border-radius: 50%;
                            box-shadow: inset 0 0 0 .1em rgba(58, 168, 237, .5);
                            z-index: 1000;
                        }
                        
                        .spinner i {
                            position: absolute;
                            width: 1em;
                            height: 1em;
                            clip: rect(0 1em 1em .5em);
                            animation: spinner-clipper .9s ease-in-out infinite;
                        }
                        
                        .wrap {
                            width: 100%;
                            height: 80vh;
                            position: relative;
                            margin: 0 auto;
                            background-color: transparent;
                            overflow: hidden;
                            perspective: 800px;
                            -webkit-perspective: 800px;
                        }
                        /* 海报样式 */
                        
                        .photo {
                            position: absolute;
                            width: 260px;
                            height: 320px;
                            z-index: 1;
                            box-shadow: 0 0 1px rgba(0, 0, 0, .01);
                            transition: all .5s;
                            left: 50%;
                            top: 50%;
                            margin: -160px 0 0 -130px;
                            transform: scale(1);
                            cursor: pointer;
                        }
                        /* 负责翻转 */
                        
                        .photo .photo-wrap {
                            position: absolute;
                            width: 100%;
                            height: 100%;
                            transform-style: preserve-3d;
                            -webkit-transform-style: preserve-3d;
                            transition: all .6s ease-in-out;
                            transform-origin: 0% 50% 0px;
                            -ms-transform-origin: 0% 50% 0px;
                            -webkit-transform-origin: 0% 50% 0px;
                            -moz-transform-origin: 0% 50% 0px;
                        }
                        
                        .photo .photo-wrap .side {
                            position: absolute;
                            width: 210%;
                            height: 100%;
                            background-color: #eee;
                            top: 0;
                            right: -150px;
                            padding: 20px;
                            box-sizing: border-box;
                            backface-visibility: hidden;
                            -webkit-backface-visibility: hidden;
                            -moz-backface-visibility: hidden;
                            -ms-backface-visibility: hidden;
                            overflow: auto;
                            -webkit-overflow-scrolling: touch;
                        }
                        
                        .photo .photo-wrap .side::-webkit-scrollbar {
                            display: none;
                        }
                        
                        .photo .photo-wrap .side-front {
                            transform: rotateY(0deg);
                        }
                        
                        .photo .photo-wrap .side-front .image {
                            width: 100%;
                            height: 280px;
                            line-height: 250px;
                            overflow: hidden;
                        }
                        
                        .photo .photo-wrap .side-front .image img {
                            width: 100%;
                            vertical-align: middle;
                        }
                        
                        .photo .photo-wrap .side-back {
                            transform: rotateY(180deg);
                        }
                        
                        .photo .photo-wrap .side-back .caption {
                            text-align: center;
                            font-size: 20px;
                            line-height: 100px;
                            color: #333;
                        }
                        
                        .photo .photo-wrap .side-back .desc {
                            color: #666;
                            font-size: 14px;
                            line-height: 2.5em;
                            padding: 0 40px;
                        }
                        
                        .photo_center {
                            top: 50%;
                            left: 50%;
                            margin: -160px 0 0 -130px;
                            z-index: 2;
                            transform: scale(1.3);
                        }
                        
                        .photo_front .photo-wrap {
                            transform: translate(0, 0) rotateY(0deg);
                        }
                        
                        .photo_back .photo-wrap {
                            transform: translate(260px, 0px) rotateY(180deg);
                        }
                        
                        .nav-gallery {
                            position: absolute;
                            width: 80%;
                            left: 10%;
                            height: 30px;
                            line-height: 30px;
                            bottom: 20px;
                            z-index: 3;
                            text-align: center;
                        }
                        
                        .nav-gallery .i {
                            display: inline-block;
                            width: 30px;
                            height: 30px;
                            cursor: pointer;
                            background-color: #aaa;
                            text-align: center;
                            border-radius: 50%;
                            transform: scale(.5);
                            transition: all .5s;
                        }
                        
                        .nav-gallery .i::after {
                            content: '\27F2';
                            font-family: 'Font Awesome 6 Free';
                            font-weight: 900;
                            font-size: 20px;
                            display: inline-block;
                            line-height: 30px;
                            text-align: center;
                            color: #fff;
                            opacity: 0;
                        }
                        /* 选中样式 */
                        
                        .nav-gallery .i_current {
                            transform: scale(1);
                            background-color: <%=theme.photo.theme_color || '#2b2be2' %>;
                        }
                        
                        .nav-gallery .i_current::after {
                            opacity: 1;
                        }
                        /* 背面样式 */
                        
                        .nav-gallery .i_back {
                            background-color: #555;
                            transform: rotateY(180deg);
                        }
                        
                        [cloak] {
                            opacity: 0 !important;
                        }
                        /* 动画 */
                        
                        @keyframes spinner-clipper {
                            from {
                                transform: rotate(0deg);
                            }
                            to {
                                transform: rotate(180deg);
                            }
                        }
                        
                        @media (max-width: 768px) {
                            .wrap {
                                height: 500px;
                            }
                            .photo {
                                width: 220px;
                                height: 280px;
                                margin: -140px 0 0 -110px;
                            }
                            .photo_center {
                                margin: -140px 0 0 -110px;
                            }
                            .photo .photo-wrap .side-front .image {
                                height: 210px;
                                line-height: 210px;
                            }
                        }
                    </style>

                    <script>
                        /* 随机函数 min~max */
                        function random(range) {
                            var max = Math.max(range[0], range[1]);
                            var min = Math.min(range[0], range[1]);
                            var diff = max - min;
                            return Math.round(Math.random() * diff + min)
                        }

                        /* 计算左右分区的范围，使其他海报的显示不会超出此范围 */
                        function range() {
                            var range = {
                                left: {
                                    x: [],
                                    y: []
                                },
                                right: {
                                    x: [],
                                    y: []
                                }
                            };

                            //获取最外围容器的宽度和高度
                            var wrap = {
                                width: document.getElementById('wrap').clientWidth,
                                height: document.getElementById('wrap').clientHeight
                            };

                            //获取每一张海报的宽度和高度，因为海报的大小都是一样的，所以取第一张
                            var photo = {
                                width: document.getElementsByClassName('photo')[0].clientWidth,
                                height: document.getElementsByClassName('photo')[0].clientHeight
                            };

                            range.left.x = [0 - photo.width / 4, wrap.width / 2 - photo.width * 3 / 4];
                            range.left.y = [photo.height / 4, wrap.height - photo.height / 4];
                            range.right.x = [wrap.width / 2 + photo.width * 3 / 4, wrap.width + photo.width / 4];
                            range.right.y = range.left.y;

                            return range;
                        }

                        /* 海报排序 */
                        function poster_sort(no) {
                            var _photo = document.getElementsByClassName('photo');
                            var photos = [];

                            for (var i = 0; i < _photo.length; i++) {
                                /*重排序之前去除所有图片样式*/
                                _photo[i].className = "photo photo_front";
                                /* 清除位置 */
                                _photo[i].style.left = _photo[i].style.top = '';
                                /* 清除transform：rotate() */
                                _photo[i].style.transform = _photo[i].style.webkitTransform = '';

                                photos.push(_photo[i]);
                            }

                            var photo_center = document.getElementById('photo_' + no);
                            photo_center.className += " photo_center";

                            //把photo_center从数组里删掉
                            photos.splice(no - 1, 1);

                            // 把剩下的海报分为左右两部分
                            var photos_left = photos.splice(0, Math.ceil(photos.length / 2));
                            var photos_right = photos;
                            var ranges = range();

                            // 对左右区域的海报位置进行随机赋值
                            for (var j = 0; j < photos_left.length; j++) {
                                var photo = photos_left[j];
                                photo.style.left = random(ranges.left.x) + 'px';
                                photo.style.top = random(ranges.left.y) + 'px';
                                photo.style.transform = photo.style.webkitTransform = 'rotate(' + random([-150, 150]) + 'deg)';
                            }

                            for (var s = 0; s < photos_right.length; s++) {
                                var photo = photos_right[s];
                                photo.style.left = random(ranges.right.x) + 'px';
                                photo.style.top = random(ranges.right.y) + 'px';
                                photo.style.transform = photo.style.webkitTransform = 'rotate(' + random([-150, 150]) + 'deg)';
                            }

                            // 控制按钮处理
                            var navs = document.getElementsByClassName('i');
                            for (var k = 0; k < navs.length; k++) {
                                navs[k].className = 'i';
                            }
                            document.getElementById('nav_' + no).className += ' i_current';
                        }

                        /* 图片翻转 */
                        function turn(elem) {
                            var cls = elem.className;
                            var n = elem.id.split('_')[1];

                            if (!/photo_center/.test(cls)) {
                                return poster_sort(n);
                            }

                            if (/photo_front/.test(cls)) {
                                cls = cls.replace(/photo_front/, 'photo_back');
                                //nav
                                document.getElementById('nav_' + n).className += ' i_back';
                            } else {
                                cls = cls.replace(/photo_back/, 'photo_front');
                                //nav
                                document.getElementById('nav_' + n).className = document.getElementById('nav_' + n).className.replace(/\s*i_back\s*/, '');
                            }

                            elem.className = cls;
                        }

                        // 初始化照片画廊
                        document.addEventListener('DOMContentLoaded', function() {
                            // 随机选择一张照片作为中心
                            var photoCount = document.getElementsByClassName('photo').length;
                            if (photoCount > 0) {
                                poster_sort(random([1, photoCount]));
                            }

                            // 显示画廊
                            setTimeout(function() {
                                document.querySelector('[cloak]').removeAttribute('cloak');
                                document.querySelector('.spinner').style.display = 'none';
                            }, 500);
                        });
                    </script>
                    </div>
                    </div>
                    </div>

                    <%- partial('footer') %>
                        <%- partial('after-footer') %>